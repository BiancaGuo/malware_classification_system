# -*- coding: UTF-8 -*-
import os
import re
import hashlib

def get_all_files(rootdir):
    files = []
    list = os.listdir(rootdir)  # 列出文件夹下所有的目录与文件
    for i in range(0, len(list)):
        path = os.path.join(rootdir, list[i])
        if os.path.isdir(path):
            files.extend(get_all_files(path))
        if os.path.isfile(path):
            files.append(path)
    return files

def getOpcodeSequence(filename):
    opcode_seq = []
    p = re.compile(r'[\s]{16}([a-z]+)$|[\s]{16}([a-z]+[\s]{2})')
    with open(filename,encoding='utf-8') as f:
        f=list(f)
        for i in range(0,len(f)):
            if str(f[i]).strip()=="; Segment type: Pure code":
                for j in range(i+1,len(f)):
                    if re.match(r"; Segment type:*",str(f[j]).strip()) or j==len(f)-1:
                        i=j
                        break
                    m = re.findall(p,str(f[j]))
                    # print(str(f[j]))
                    if m:
                        # print(m)
                        opc = str(m[0][1]).strip()
                        opc2 = str(m[0][0]).strip()
                        if opc!='' and opc != "align" and opc != "db":
                            opcode_seq.append(opc)
                        elif opc2!='' and opc2 != "align" and opc2 != "db":
                            opcode_seq.append(opc2)
            # if flag==1:
            #     break

    return opcode_seq


if __name__== "__main__":
    for i in range(1,8):
        dir="D:\\PE_asm_file\\"+str(i)#backdoors\rootkits\spywares\trojans\worms
        file_list=get_all_files(dir)
        # filename="D:\\PE_asm_file\\2\\434e55eb93ca201c97d50e12ce64de11.asm"
        for file in file_list:
            print(file)
            opcode_sequence=getOpcodeSequence(file)
            asm_washed = ""
            for j in range(0, len(opcode_sequence)):
                asm_washed += opcode_sequence[j].strip()
                asm_washed += "\n"
            base_path="E:\\PE_opcode_file\\"+str(i)+"\\"
            name=file[17:-4]+".txt"
            f = open(base_path+name, 'w')  # 若是'wb'就表示写二进制文件
            f.write(asm_washed)
            f.close()

    '''
    for test
    '''
    # filename="D:\\PE_asm_file\\5\\0a7135dfdb1bd11de9ce5b3f18fc24af.asm"
    #
    # opcode_sequence=getOpcodeSequence(filename)
    # asm_washed = ""
    # for j in range(0, len(opcode_sequence)):
    #     asm_washed += opcode_sequence[j].strip()
    #     asm_washed += "\n"
    #
    # f = open("1.txt", 'w')  # 若是'wb'就表示写二进制文件
    # f.write(asm_washed)
    # f.close()
    #

