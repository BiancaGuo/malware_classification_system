# 测试集：F:\\PE_dynamic_feature\\test\\
# 训练集：F:\\PE_dynamic_feature\\train\\
import os
import pandas as pd

def get_all_files(rootdir):
    files = []
    list = os.listdir(rootdir)  # 列出文件夹下所有的目录与文件
    for i in range(0, len(list)):
        path = os.path.join(rootdir, list[i])
        if os.path.isdir(path):
            files.extend(get_all_files(path))
        if os.path.isfile(path):
            files.append(path)
    return files

def get_api_from_file(filename):
    api_sequence=[]
    with open(filename) as f:
        f_list=f.read().splitlines()
        tmp=f_list[0]
        api_sequence.append(tmp.rstrip('\n').strip())
        for line_num in range(1,len(f_list)):
            # print(tmp+"----"+f_list[line_num])
            if f_list[line_num] != tmp:
                api_sequence.append(f_list[line_num].rstrip('\n').strip())
                # print("hhh")
            tmp=f_list[line_num]
    return api_sequence

if __name__ == '__main__':
    file_id=[]
    label=[]
    api=[]
    for type in range(1,8):
        train_file_path="F:\\PE_dynamic_feature\\train\\"+str(type)+"\\"
        # test_file_path="F:\\PE_dynamic_feature\\test\\"+str(type)+"\\"
        train_files=get_all_files(train_file_path)
        for train_file in train_files:
            apis=get_api_from_file(train_file)
            file_name=os.path.basename(train_file)
            file_len=len(apis)
            for i in range(0,file_len):
                file_id.append(file_name)
                label.append(type)
                api.append(apis[i])
        # if type==1:
        #     for train_file in train_files:
        #         apis=get_api_from_file(train_file)
        #         apis = apis + get_api_from_file(train_file)
        #         apis = apis + get_api_from_file(train_file)
        #         apis = apis + get_api_from_file(train_file)
        #         file_name=os.path.basename(train_file)
        #         file_len=len(apis)
        #         for i in range(0,file_len):
        #             file_id.append(file_name)
        #             label.append(type)
        #             api.append(apis[i])
        # else:
        #     for train_file in train_files:
        #         apis=get_api_from_file(train_file)
        #         file_name=os.path.basename(train_file)
        #         file_len=len(apis)
        #         for i in range(0,file_len):
        #             file_id.append(file_name)
        #             label.append(type)
        #             api.append(apis[i])

    dataframe = pd.DataFrame({'file_id': file_id, 'label': label,'api':api})
    dataframe.to_csv("dynamic_feature_train.csv", index=False, sep=',')
