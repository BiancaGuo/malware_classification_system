# -*- coding: UTF-8 -*-
'''
function: 使用cuckoo获得exe文件API序列
'''

import os
import json
import shutil

def copy_file():
    root_path = 'C:\\Users\\47892\\.cuckoo\\storage\\analyses\\'  # cuckoo的分析结果路径
    result_path = 'F:\\PE_dynamic_feature\\7\\' # report、pcap、源文件安置路径
    for num in range(1, 51):
        sreport_path = root_path + str(num) + '\\reports\\report.json'
        if os.path.exists(sreport_path):
            #print sreport_path
            f = open(sreport_path, 'r')
            root = json.load(f)
            f.close()
            #print root
            md5 = root['target']['file']['md5']
            dreport_path = result_path + str(md5) + '.json'
            shutil.copy(sreport_path, dreport_path)


def GetFileList(dir,fileList):
    newDir = dir
    if os.path.isfile(dir):
        fileList.append(dir.decode('gbk'))
    elif os.path.isdir(dir):
        for s in os.listdir(dir):
            #如果需要忽略某些文件夹，使用以下代码
            #if s == "xxx":
                #continue
            newDir=os.path.join(dir,s)
            GetFileList(newDir, fileList)
    return fileList

def extract_api_sequence():
    '''
    遍历目录每一个文件，提取API名称，存入对应txt文件
    '''
    path='F:\\PE_dynamic_feature\\7\\'
    fileList = []
    fileList=GetFileList(path,fileList)
    for f in fileList:
        print(f)
        file_name=f[0:-5]+'.txt'
        print(file_name)
        if os.path.exists(file_name) == False and f[-1]=='n':
            file = open(f, 'r')
            root = json.load(file)
            file.close()
            try:
                api_names=root["behavior"]["processes"][1]["calls"]
                api_name=""
                for call in api_names:
                    api_name += call["api"]
                    api_name += "\n"
                f_tmp = open(file_name, 'w')  # 若是'wb'就表示写二进制文件
                f_tmp.write(api_name)
                f_tmp.close()
            except:
                print("wrong:"+f)


def extract_api_sequence_from_one_file(filepath):
    '''
    从用户提交的cuckoo_log中提取API名称，存入对应txt文件
    '''
    print(filepath)
    file_name = os.path.dirname(filepath) + "\\APIs.txt"
    file = open(filepath, 'r')
    root = json.load(file)
    file.close()
    api_names=root["behavior"]["processes"][1]["calls"]
    api_name=[]
    for call in api_names:
        api_name.append(call["api"])
    return api_name


if __name__ == "__main__":
    # copy_file() #将cuckoo分析结果移动到指定文件夹
    extract_api_sequence()#提取API序列